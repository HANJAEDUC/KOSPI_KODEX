<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ìŠ¤í¬ë¦¬ë‹ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

    <div class="header-container">
        <h1>ğŸ“Š ì£¼ì‹ ìŠ¤í¬ë¦¬ë‹ ëŒ€ì‹œë³´ë“œ</h1>
        <p class="subtitle">KOSPI & KOSDAQ ì „ëµ</p>
        <div class="status-bar">
            <span>ì‹ í˜¸ ì—…ë°ì´íŠ¸ì¼: <strong id="signal-date">-</strong></span>
        </div>
    </div>
    </header>

    <main class="grid-container">

        <!-- Row 1: ê³¨ë“ í¬ë¡œìŠ¤ / ëˆŒë¦¼ ë§¤ìˆ˜ ì‹ í˜¸ -->
        <section class="panel">
            <h2 style="display:flex; justify-content:space-between; align-items:center;">
                <span>ğŸ“ˆ ê°€ê²© ê³¨ë“ í¬ë¡œìŠ¤ <span class="badge">MA20 > MA200</span></span>
                <div class="scanner-panel" style="font-size:12px;">
                    <button id="btn-scan-price" class="btn btn-primary"
                        onclick="startScan('price_gc', 'btn-scan-price', 'prog-price')">ğŸš€ ìŠ¤ìº” ì‹¤í–‰</button>
                    <div id="prog-price" style="display: none; width:200px; text-align:left;">
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" id="fill-price"></div>
                        </div>
                        <div class="progress-text" id="msg-price">ëŒ€ê¸° ì¤‘...</div>
                    </div>
                </div>
            </h2>
            <div class="tabs">
                <button class="tab-btn active" data-target="gc-kospi">KOSPI</button>
                <button class="tab-btn" data-target="gc-kosdaq">KOSDAQ</button>
            </div>
            <div class="table-wrapper tab-content active" id="gc-kospi">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‹œê°€ì´ì•¡(ì–µ)</th>
                            <th>ì¢…ê°€</th>
                            <th>MA20</th>
                            <th>MA200</th>
                            <th>ê°­(%)</th>
                            <th>í¬ë¡œìŠ¤ì¼</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-gc-kospi"></tbody>
                </table>
            </div>
            <div class="table-wrapper tab-content" id="gc-kosdaq" style="display:none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‹œê°€ì´ì•¡(ì–µ)</th>
                            <th>ì¢…ê°€</th>
                            <th>MA20</th>
                            <th>MA200</th>
                            <th>ê°­(%)</th>
                            <th>í¬ë¡œìŠ¤ì¼</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-gc-kosdaq"></tbody>
                </table>
            </div>
        </section>

        <section class="panel">
            <h2 style="display:flex; justify-content:space-between; align-items:center;">
                <span>ğŸ“Š ê±°ë˜ëŸ‰ ê¸‰ì¦ (Volume MA) <span class="badge">V_MA5 > V_MA20</span></span>
                <div class="scanner-panel" style="font-size:12px;">
                    <button id="btn-scan-vol" class="btn btn-primary"
                        onclick="startScan('vol_gc', 'btn-scan-vol', 'prog-vol')">ğŸš€ ìŠ¤ìº” ì‹¤í–‰</button>
                    <div id="prog-vol" style="display: none; width:200px; text-align:left;">
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" id="fill-vol"></div>
                        </div>
                        <div class="progress-text" id="msg-vol">ëŒ€ê¸° ì¤‘...</div>
                    </div>
                </div>
            </h2>
            <div class="tabs">
                <button class="tab-btn active" data-target="vol-kospi">KOSPI</button>
                <button class="tab-btn" data-target="vol-kosdaq">KOSDAQ</button>
            </div>
            <div class="table-wrapper tab-content active" id="vol-kospi">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‹œê°€ì´ì•¡(ì–µ)</th>
                            <th>ì¢…ê°€</th>
                            <th>V_MA5</th>
                            <th>V_MA20</th>
                            <th>ë¹„ìœ¨(ë°°)</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-vol-kospi"></tbody>
                </table>
            </div>
            <div class="table-wrapper tab-content" id="vol-kosdaq" style="display:none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‹œê°€ì´ì•¡(ì–µ)</th>
                            <th>ì¢…ê°€</th>
                            <th>V_MA5</th>
                            <th>V_MA20</th>
                            <th>ë¹„ìœ¨(ë°°)</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-vol-kosdaq"></tbody>
                </table>
            </div>
        </section>

        <!-- Row 2: ëˆŒë¦¼ ë§¤ìˆ˜ ì‹ í˜¸ -->
        <section class="panel highlight-panel" style="grid-column: 1 / -1;">
            <h2 style="display:flex; justify-content:space-between; align-items:center;">
                <span>ğŸ”¥ ê³¨ë“ í¬ë¡œìŠ¤ ëˆŒë¦¼ ë§¤ìˆ˜ ì‹ í˜¸ (ìµœì¢… íƒ€ì )</span>
                <div class="scanner-panel" style="font-size:12px;">
                    <button id="btn-scan-pb" class="btn btn-primary"
                        onclick="startScan('pullback', 'btn-scan-pb', 'prog-pb')">ğŸš€ ìŠ¤ìº” ì‹¤í–‰</button>
                    <div id="prog-pb" style="display: none; width:200px; text-align:left;">
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" id="fill-pb"></div>
                        </div>
                        <div class="progress-text" id="msg-pb">ëŒ€ê¸° ì¤‘...</div>
                    </div>
                </div>
            </h2>
            <div class="tabs">
                <button class="tab-btn active" data-target="pb-kospi">KOSPI</button>
                <button class="tab-btn" data-target="pb-kosdaq">KOSDAQ</button>
            </div>
            <div class="table-wrapper tab-content active" id="pb-kospi">
                <table class="data-table highlight-table">
                    <thead>
                        <tr>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‹œê°€ì´ì•¡</th>
                            <th>ì¢…ê°€</th>
                            <th>GCë°œìƒ</th>
                            <th>ëˆŒë¦¼ì¼</th>
                            <th>ì‹ í˜¸ìœ í˜•</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-pb-kospi"></tbody>
                </table>
            </div>
            <div class="table-wrapper tab-content" id="pb-kosdaq" style="display:none;">
                <table class="data-table highlight-table">
                    <thead>
                        <tr>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‹œê°€ì´ì•¡</th>
                            <th>ì¢…ê°€</th>
                            <th>GCë°œìƒ</th>
                            <th>ëˆŒë¦¼ì¼</th>
                            <th>ì‹ í˜¸ìœ í˜•</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-pb-kosdaq"></tbody>
                </table>
            </div>
        </section>

        <section class="panel instruction-panel" style="grid-column: 1 / -1;">
            <h2>ğŸ’¡ íˆ¬ì ì „ëµ ê°€ì´ë“œ</h2>
            <div class="guide-content">
                <h3>ë§¤ìˆ˜ íƒ€ì  ë¶„ì„</h3>
                <ul>
                    <li><strong>1ë‹¨ê³„:</strong> 'ê°€ê²©/ê±°ë˜ëŸ‰ ê³¨ë“ í¬ë¡œìŠ¤' íŒ¨ë„ì—ì„œ MA20ì´ MA200ì„ ìƒí–¥ ëŒíŒŒí•˜ë©° ì¥ê¸° ìƒìŠ¹ ì¶”ì„¸ ì§„ì… ì¢…ëª© í™•ì¸</li>
                    <li><strong>2ë‹¨ê³„:</strong> í¬ë¡œìŠ¤ ë°œìƒ ì§í›„ 3~10ì¼ ë‚´ ì €ì ì„ ë‹¤ì§€ë©° MA20ì— ì•ˆì°©í•œ ì¢…ëª© ëŒ€ê¸°</li>
                    <li><strong>3ë‹¨ê³„:</strong> 'ëˆŒë¦¼ ë§¤ìˆ˜ ì‹ í˜¸' íŒ¨ë„ì—ì„œ ë‹¹ì¼ ì–‘ë´‰ ì „í™˜ ë° ì „ì¼ ê³ ê°€ë¥¼ ëŒíŒŒ(<span class="signal-badge"
                            style="font-size:10px;">ğŸ””ì˜¤ëŠ˜ ì‹ í˜¸</span>) ì‹œ ì ê·¹ ë§¤ìˆ˜ ê³ ë ¤</li>
                </ul>
            </div>
        </section>

    </main>

    <script>
        // ì˜¤ëŠ˜ ë‚ ì§œ ë° ì˜ì—…ì¼ ì„¤ì •
        function getRecentBusinessDay() {
            const d = new Date();
            if (d.getHours() < 9) d.setDate(d.getDate() - 1);
            while (d.getDay() === 0 || d.getDay() === 6) {
                d.setDate(d.getDate() - 1);
            }
            return d.toISOString().split('T')[0];
        }

        // íƒ­ ì „í™˜ ë¡œì§
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const parent = this.closest('.panel');
                parent.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                parent.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

                this.classList.add('active');
                document.getElementById(this.dataset.target).style.display = 'block';
            });
        });

        // ì‹ í˜¸ ë°ì´í„° ë° ê±°ë˜ëŸ‰ GC ê°€ì ¸ì˜¤ê¸°
        async function fetchSignals() {
            try {
                const res = await fetch('/api/signals');
                const json = await res.json();
                if (json.ok) {
                    document.getElementById('signal-date').textContent = json.data.last_updated;

                    renderTable('tbody-gc-kospi', json.data.price_gc_kospi, ['ìˆœìœ„(ì‹œì´)', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'MA20', 'MA200', 'MA20_MA200ê°­(%)', 'ê³¨ë“ í¬ë¡œìŠ¤ì¼']);
                    renderTable('tbody-gc-kosdaq', json.data.price_gc_kosdaq, ['ìˆœìœ„(ì‹œì´)', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'MA20', 'MA200', 'MA20_MA200ê°­(%)', 'ê³¨ë“ í¬ë¡œìŠ¤ì¼']);

                    renderTable('tbody-vol-kospi', json.data.vol_gc_kospi, ['ìˆœìœ„(ì‹œì´)', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'V_MA5', 'V_MA20', 'Volume_Ratio(ë°°)']);
                    renderTable('tbody-vol-kosdaq', json.data.vol_gc_kosdaq, ['ìˆœìœ„(ì‹œì´)', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'V_MA5', 'V_MA20', 'Volume_Ratio(ë°°)']);

                    renderTable('tbody-pb-kospi', json.data.pullback_kospi, ['ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'GCë°œìƒì¼', 'ëˆŒë¦¼ì¼', 'ì‹ í˜¸ìœ í˜•']);
                    renderTable('tbody-pb-kosdaq', json.data.pullback_kosdaq, ['ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'GCë°œìƒì¼', 'ëˆŒë¦¼ì¼', 'ì‹ í˜¸ìœ í˜•']);

                    highlightTodaySignals();
                }
            } catch (e) { console.error('Signal fetch error:', e); }
        }

        // ë¶„ë¦¬ëœ ìŠ¤ìºë„ˆ ì‹¤í–‰ ë¡œì§
        const intervals = {};

        async function startScan(target, btnId, progId) {
            if (!confirm(`í•´ë‹¹ íŒ¨í„´( ${target} )ì˜ ìµœì‹  ë°ì´í„°ë¥¼ ìŠ¤ìº”í•©ë‹ˆë‹¤ (ì•½ 5~10ë¶„ ì†Œìš”). ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const res = await fetch('/api/scan/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: target })
                });
                const json = await res.json();

                if (json.ok) {
                    monitorScan(target, btnId, progId);
                } else {
                    alert(json.message);
                }
            } catch (e) { alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜"); }
        }

        function monitorScan(target, btnId, progId) {
            document.getElementById(btnId).style.display = 'none';
            document.getElementById(progId).style.display = 'block';

            if (intervals[target]) clearInterval(intervals[target]);

            intervals[target] = setInterval(async () => {
                try {
                    const res = await fetch(`/api/scan/status?target=${target}`);
                    const json = await res.json();

                    if (json.ok) {
                        const state = json.data;

                        // html id mapping (price_gc -> fill-price ë“±)
                        let prefix = 'pb';
                        if (target === 'price_gc') prefix = 'price';
                        if (target === 'vol_gc') prefix = 'vol';

                        const fillEl = document.getElementById(`fill-${prefix}`);
                        const msgEl = document.getElementById(`msg-${prefix}`);

                        fillEl.style.width = `${state.progress}%`;
                        msgEl.innerHTML = `<strong>${state.progress.toFixed(1)}%</strong> | ${state.message} (ë°œê²¬: ${state.signals_found})`;

                        if (!state.is_running && state.progress >= 100) {
                            clearInterval(intervals[target]);
                            msgEl.innerHTML = "âœ… ì™„ë£Œ! (ìƒˆë¡œê³ ì¹¨ ì‹œ ë°˜ì˜)";
                        } else if (!state.is_running && state.progress < 100 && state.progress > 0) {
                            clearInterval(intervals[target]);
                            msgEl.innerHTML = "âŒ ìƒíƒœ ì˜¤ë¥˜";
                            document.getElementById(btnId).style.display = 'inline-block';
                        }
                    }
                } catch (e) { }
            }, 2000);
        }

        // ì¼ë°˜ í…Œì´ë¸” ë Œë”ë§
        function renderTable(tbodyId, dataArray, columns) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';

            if (!dataArray || dataArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${columns.length}" class="empty-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }

            dataArray.forEach(row => {
                const tr = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    let val = row[col] !== undefined ? row[col] : '-';

                    // ì‹ í˜¸ ìœ í˜• ê°•ì¡°
                    if (col === 'ì‹ í˜¸ìœ í˜•' && typeof val === 'string' && val.includes('ì˜¤ëŠ˜ ì‹ í˜¸')) {
                        val = `<span class="signal-badge">${val}</span>`;
                    }

                    td.innerHTML = val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // íˆ¬ìì í…Œì´ë¸” ë Œë”ë§
        function renderInvestorTable(tbodyId, dataArray) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';

            if (!dataArray || dataArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="empty-msg">KRX ì„œë²„ ì‘ë‹µ ì—†ìŒ (ë´‡ ì°¨ë‹¨ ë˜ëŠ” ë°ì´í„° ë¯¸ì œê³µ).<br>HTS/MTSì—ì„œ ì§ì ‘ í™•ì¸í•´ ì£¼ì„¸ìš”.</td></tr>`;
                return;
            }

            dataArray.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${idx + 1}</td>
            <td class="font-bold">${row['ì¢…ëª©ëª…']}</td>
            <td class="text-right text-highlight">${row['ìˆœë§¤ìˆ˜ê±°ë˜ëŸ‰']}</td>
        `;
                tbody.appendChild(tr);
            });
        }

        function highlightTodaySignals() {
            document.querySelectorAll('.highlight-table tr').forEach(tr => {
                if (tr.innerHTML.includes('ì˜¤ëŠ˜ ì‹ í˜¸')) {
                    tr.classList.add('row-highlight');
                }
            });
        }

        // ì´ˆê¸° ë¡œë”©
        fetchSignals();

    </script>
</body>

</html>