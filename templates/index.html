<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ìŠ¤í¬ë¦¬ë‹ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

    <div class="header-container">
        <h1>ğŸ“Š ì£¼ì‹ ìŠ¤í¬ë¦¬ë‹ ëŒ€ì‹œë³´ë“œ</h1>
        <p class="subtitle">KOSPI & KOSDAQ ì „ëµ</p>
        <div class="status-bar">
            <span>ê¸°ì¤€ì¼ ì„ íƒ: <input type="date" id="global-target-date" class="date-picker"></span>
            <span>ë§ˆì§€ë§‰ ë°ì´í„° ì—…ë°ì´íŠ¸: <strong id="signal-date">-</strong></span>
        </div>
    </div>
    </header>

    <main class="grid-container">

        <!-- Row 1: ê³¨ë“ í¬ë¡œìŠ¤ / ëˆŒë¦¼ ë§¤ìˆ˜ ì‹ í˜¸ -->
        <section class="panel">
            <h2 style="display:flex; justify-content:space-between; align-items:center;">
                <span>ğŸ“ˆ ê°€ê²© ê³¨ë“ í¬ë¡œìŠ¤ <span class="badge">MA20 > MA200</span></span>
                <div class="scanner-panel" style="font-size:12px;">
                    <button id="btn-scan-price" class="btn btn-primary"
                        onclick="startScan('price_gc', 'btn-scan-price', 'prog-price')">ğŸš€ ìŠ¤ìº” ì‹¤í–‰</button>
                    <div id="prog-price" style="display: none; width:300px; text-align:left; align-items:center;">
                        <span id="msg-price" style="flex:1;">ëŒ€ê¸° ì¤‘...</span>
                        <button id="btn-stop-price" class="btn btn-danger"
                            style="margin-left:8px; padding:2px 6px; font-size:11px;"
                            onclick="stopScan('price_gc', 'btn-scan-price', 'prog-price', 'btn-stop-price')">ğŸ›‘ì¤‘ì§€</button>
                    </div>
                </div>
            </h2>
            <div class="tabs">
                <button class="tab-btn active" data-target="gc-kospi">KOSPI</button>
                <button class="tab-btn" data-target="gc-kosdaq">KOSDAQ</button>
            </div>
            <div class="table-wrapper tab-content active" id="gc-kospi">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‹œê°€ì´ì•¡(ì–µ)</th>
                            <th>ì¢…ê°€</th>
                            <th>MA20</th>
                            <th>MA200</th>
                            <th>ê°­(%)</th>
                            <th>í¬ë¡œìŠ¤ì¼</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-gc-kospi"></tbody>
                </table>
            </div>
            <div class="table-wrapper tab-content" id="gc-kosdaq" style="display:none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‹œê°€ì´ì•¡(ì–µ)</th>
                            <th>ì¢…ê°€</th>
                            <th>MA20</th>
                            <th>MA200</th>
                            <th>ê°­(%)</th>
                            <th>í¬ë¡œìŠ¤ì¼</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-gc-kosdaq"></tbody>
                </table>
            </div>
        </section>

        <section class="panel">
            <h2 style="display:flex; justify-content:space-between; align-items:center;">
                <span>ğŸ“Š ê±°ë˜ëŸ‰ ê¸‰ì¦ (Volume MA) <span class="badge">V_MA5 > V_MA20</span></span>
                <div class="scanner-panel" style="font-size:12px;">
                    <button id="btn-scan-vol" class="btn btn-primary"
                        onclick="startScan('vol_gc', 'btn-scan-vol', 'prog-vol')">ğŸš€ ìŠ¤ìº” ì‹¤í–‰</button>
                    <div id="prog-vol" style="display: none; width:300px; text-align:left; align-items:center;">
                        <span id="msg-vol" style="flex:1;">ëŒ€ê¸° ì¤‘...</span>
                        <button id="btn-stop-vol" class="btn btn-danger"
                            style="margin-left:8px; padding:2px 6px; font-size:11px;"
                            onclick="stopScan('vol_gc', 'btn-scan-vol', 'prog-vol', 'btn-stop-vol')">ğŸ›‘ì¤‘ì§€</button>
                    </div>
                </div>
            </h2>
            <div class="tabs">
                <button class="tab-btn active" data-target="vol-kospi">KOSPI</button>
                <button class="tab-btn" data-target="vol-kosdaq">KOSDAQ</button>
            </div>
            <div class="table-wrapper tab-content active" id="vol-kospi">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‹œê°€ì´ì•¡(ì–µ)</th>
                            <th>ì¢…ê°€</th>
                            <th>V_MA5</th>
                            <th>V_MA20</th>
                            <th>ë¹„ìœ¨(ë°°)</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-vol-kospi"></tbody>
                </table>
            </div>
            <div class="table-wrapper tab-content" id="vol-kosdaq" style="display:none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‹œê°€ì´ì•¡(ì–µ)</th>
                            <th>ì¢…ê°€</th>
                            <th>V_MA5</th>
                            <th>V_MA20</th>
                            <th>ë¹„ìœ¨(ë°°)</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-vol-kosdaq"></tbody>
                </table>
            </div>
        </section>

        <!-- Row 2: ëˆŒë¦¼ ë§¤ìˆ˜ ì‹ í˜¸ -->
        <section class="panel highlight-panel" style="grid-column: 1 / -1;">
            <h2 style="display:flex; justify-content:space-between; align-items:center;">
                <span>ğŸ”¥ ê³¨ë“ í¬ë¡œìŠ¤ ëˆŒë¦¼ ë§¤ìˆ˜ ì‹ í˜¸ (ìµœì¢… íƒ€ì )</span>
                <div class="scanner-panel" style="font-size:12px;">
                    <button id="btn-scan-pb" class="btn btn-primary"
                        onclick="startScan('pullback', 'btn-scan-pb', 'prog-pb')">ğŸš€ ìŠ¤ìº” ì‹¤í–‰</button>
                    <div id="prog-pb" style="display: none; width:300px; text-align:left; align-items:center;">
                        <span id="msg-pb" style="flex:1;">ëŒ€ê¸° ì¤‘...</span>
                        <button id="btn-stop-pb" class="btn btn-danger"
                            style="display:none; margin-left:8px; padding:2px 6px; font-size:11px;"
                            onclick="stopScan('pullback', 'btn-scan-pb', 'prog-pb', 'btn-stop-pb')">ğŸ›‘ì¤‘ì§€</button>
                    </div>
                </div>
            </h2>
            <div class="tabs">
                <button class="tab-btn active" data-target="pb-kospi">KOSPI</button>
                <button class="tab-btn" data-target="pb-kosdaq">KOSDAQ</button>
            </div>
            <div class="table-wrapper tab-content active" id="pb-kospi">
                <table class="data-table highlight-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‹œê°€ì´ì•¡</th>
                            <th>ì¢…ê°€</th>
                            <th>GCë°œìƒ</th>
                            <th>ëˆŒë¦¼ì¼</th>
                            <th>ì‹ í˜¸ìœ í˜•</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-pb-kospi"></tbody>
                </table>
            </div>
            <div class="table-wrapper tab-content" id="pb-kosdaq" style="display:none;">
                <table class="data-table highlight-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‹œê°€ì´ì•¡</th>
                            <th>ì¢…ê°€</th>
                            <th>GCë°œìƒ</th>
                            <th>ëˆŒë¦¼ì¼</th>
                            <th>ì‹ í˜¸ìœ í˜•</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-pb-kosdaq"></tbody>
                </table>
            </div>
        </section>

        <section class="panel instruction-panel" style="grid-column: 1 / -1;">
            <h2>ğŸ’¡ íˆ¬ì ì „ëµ ê°€ì´ë“œ</h2>
            <div class="guide-content">
                <h3>ë§¤ìˆ˜ íƒ€ì  ë¶„ì„</h3>
                <ul>
                    <li><strong>1ë‹¨ê³„:</strong> 'ê°€ê²©/ê±°ë˜ëŸ‰ ê³¨ë“ í¬ë¡œìŠ¤' íŒ¨ë„ì—ì„œ MA20ì´ MA200ì„ ìƒí–¥ ëŒíŒŒí•˜ë©° ì¥ê¸° ìƒìŠ¹ ì¶”ì„¸ ì§„ì… ì¢…ëª© í™•ì¸</li>
                    <li><strong>2ë‹¨ê³„:</strong> í¬ë¡œìŠ¤ ë°œìƒ ì§í›„ 3~10ì¼ ë‚´ ì €ì ì„ ë‹¤ì§€ë©° MA20ì— ì•ˆì°©í•œ ì¢…ëª© ëŒ€ê¸°</li>
                    <li><strong>3ë‹¨ê³„:</strong> 'ëˆŒë¦¼ ë§¤ìˆ˜ ì‹ í˜¸' íŒ¨ë„ì—ì„œ ë‹¹ì¼ ì–‘ë´‰ ì „í™˜ ë° ì „ì¼ ê³ ê°€ë¥¼ ëŒíŒŒ(<span class="signal-badge"
                            style="font-size:10px;">ğŸ””ì˜¤ëŠ˜ ì‹ í˜¸</span>) ì‹œ ì ê·¹ ë§¤ìˆ˜ ê³ ë ¤</li>
                </ul>
            </div>
        </section>

    </main>

    <script>
        // ì˜¤ëŠ˜ ë‚ ì§œ ë° ì˜ì—…ì¼ ì„¤ì •
        function getRecentBusinessDay() {
            const d = new Date();
            if (d.getHours() < 15) d.setDate(d.getDate() - 1);
            while (d.getDay() === 0 || d.getDay() === 6) {
                d.setDate(d.getDate() - 1);
            }
            return d.toISOString().split('T')[0];
        }

        // ê¸°ì¤€ì¼ ì´ˆê¸°ê°’ ì„¸íŒ…
        document.getElementById('global-target-date').value = getRecentBusinessDay();

        // íƒ­ ì „í™˜ ë¡œì§
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const parent = this.closest('.panel');
                parent.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                parent.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

                this.classList.add('active');
                document.getElementById(this.dataset.target).style.display = 'block';
            });
        });

        // ì‹ í˜¸ ë°ì´í„° ë° ê±°ë˜ëŸ‰ GC ê°€ì ¸ì˜¤ê¸°
        async function fetchSignals() {
            try {
                const res = await fetch('/api/signals');
                const json = await res.json();
                if (json.ok) {
                    document.getElementById('signal-date').textContent = json.data.last_updated;

                    renderTable('tbody-gc-kospi', json.data.price_gc_kospi, ['ìˆœìœ„(ì‹œì´)', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'MA20', 'MA200', 'MA20_MA200ê°­(%)', 'ê³¨ë“ í¬ë¡œìŠ¤ì¼']);
                    renderTable('tbody-gc-kosdaq', json.data.price_gc_kosdaq, ['ìˆœìœ„(ì‹œì´)', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'MA20', 'MA200', 'MA20_MA200ê°­(%)', 'ê³¨ë“ í¬ë¡œìŠ¤ì¼']);

                    renderTable('tbody-vol-kospi', json.data.vol_gc_kospi, ['ìˆœìœ„(ì‹œì´)', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'V_MA5', 'V_MA20', 'Volume_Ratio(ë°°)']);
                    renderTable('tbody-vol-kosdaq', json.data.vol_gc_kosdaq, ['ìˆœìœ„(ì‹œì´)', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'V_MA5', 'V_MA20', 'Volume_Ratio(ë°°)']);

                    renderTable('tbody-pb-kospi', json.data.pullback_kospi, ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'GCë°œìƒì¼', 'ëˆŒë¦¼ì¼', 'ì‹ í˜¸ìœ í˜•']);
                    renderTable('tbody-pb-kosdaq', json.data.pullback_kosdaq, ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'GCë°œìƒì¼', 'ëˆŒë¦¼ì¼', 'ì‹ í˜¸ìœ í˜•']);

                    highlightTodaySignals();
                }
            } catch (e) {
                console.error('Signal fetch error:', e);
                // ì˜¤ë¥˜ë‚˜ ë°ì´í„° ì—†ìŒ ì‹œ ë¹ˆ í…Œì´ë¸” ë Œë”ë§ ìœ ì§€
            }
        }

        // ë¶„ë¦¬ëœ ìŠ¤ìºë„ˆ ì‹¤í–‰ ë¡œì§
        const intervals = {};

        async function startScan(target, btnId, progId) {
            const selectedDate = document.getElementById('global-target-date').value;
            const topN = 0; // í•­ìƒ ì „ì²´ ì¢…ëª© ëŒ€ìƒìœ¼ë¡œ ìŠ¤ìº”
            let topNStr = 'ì „ì²´ ì¢…ëª©';


            // ìŠ¤ìº” ì‹œì‘ ì „ í…Œì´ë¸” í´ë¦¬ì–´
            if (target === 'price_gc') {
                renderTable('tbody-gc-kospi', [], ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µ)', 'ì¢…ê°€', 'MA20', 'MA200', 'ê°­(%)', 'í¬ë¡œìŠ¤ì¼']);
                renderTable('tbody-gc-kosdaq', [], ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µ)', 'ì¢…ê°€', 'MA20', 'MA200', 'ê°­(%)', 'í¬ë¡œìŠ¤ì¼']);
            } else if (target === 'vol_gc') {
                renderTable('tbody-vol-kospi', [], ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µ)', 'ì¢…ê°€', 'V_MA5', 'V_MA20', 'ë¹„ìœ¨(ë°°)']);
                renderTable('tbody-vol-kosdaq', [], ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µ)', 'ì¢…ê°€', 'V_MA5', 'V_MA20', 'ë¹„ìœ¨(ë°°)']);
            } else if (target === 'pullback') {
                renderTable('tbody-pb-kospi', [], ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡', 'ì¢…ê°€', 'GCë°œìƒ', 'ëˆŒë¦¼ì¼', 'ì‹ í˜¸ìœ í˜•']);
                renderTable('tbody-pb-kosdaq', [], ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡', 'ì¢…ê°€', 'GCë°œìƒ', 'ëˆŒë¦¼ì¼', 'ì‹ í˜¸ìœ í˜•']);
            }

            try {
                const res = await fetch('/api/scan/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: target, target_date: selectedDate, top_n: parseInt(topN) })
                });
                const json = await res.json();

                if (json.ok) {
                    monitorScan(target, btnId, progId);
                } else {
                    alert(json.message);
                }
            } catch (e) {
                console.error("Scan error:", e);
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ (Start): " + e.message);
            }
        }
        let lastItemsJson = {};

        async function stopScan(target, btnId, progId, stopBtnId) {
            try {
                const res = await fetch('/api/scan/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: target })
                });
                const json = await res.json();
                if (!json.ok) {
                    alert(json.message);
                } else {
                    // ì¦‰ì‹œ ë²„íŠ¼ì„ ë°”ê¾¸ì§€ ì•Šê³ , Stopping ë©”ì‹œì§€ë§Œ í‘œì‹œ
                    // ë‚˜ë¨¸ì§€ëŠ” monitorScanì´ backend ìƒíƒœ(is_running: false)ë¥¼ í™•ì¸í•  ë•Œ ì²˜ë¦¬ë¨
                    const prefix = target === 'price_gc' ? 'price' : (target === 'vol_gc' ? 'vol' : 'pb');
                    document.getElementById(`msg-${prefix}`).innerHTML = "ğŸ›‘ ì¤‘ì§€ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";
                    document.getElementById(stopBtnId).style.display = 'none';
                }
            } catch (e) {
                console.error("Stop error:", e);
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ (Stop): " + e.message);
            }
        }

        function monitorScan(target, btnId, progId) {
            const btnEl = document.getElementById(btnId);
            const progEl = document.getElementById(progId);

            // UI ì´ˆê¸°í™”: ì‹¤í–‰ ë²„íŠ¼ ìˆ¨ê¸°ê³  ì§„í–‰ë°” í‘œì‹œ
            btnEl.style.display = 'none';
            progEl.style.display = 'flex';

            // íƒ€ê²Ÿë³„ ID êµ¬ë¶„ê°’ (price_gc -> price, vol_gc -> vol, pullback -> pb)
            const prefix = target === 'price_gc' ? 'price' : (target === 'vol_gc' ? 'vol' : 'pb');
            const msgEl = document.getElementById(`msg-${prefix}`);
            const stopBtnEl = document.getElementById(`btn-stop-${prefix}`);

            if (intervals[target]) clearInterval(intervals[target]);

            intervals[target] = setInterval(async () => {
                try {
                    const res = await fetch(`/api/scan/status?target=${target}`);
                    const json = await res.json();

                    if (json.ok) {
                        const state = json.data;

                        // ë©”ì‹œì§€ ë° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                        if (msgEl) msgEl.innerHTML = `${state.message} (ë°œê²¬: ${state.signals_found})`;
                        if (stopBtnEl) stopBtnEl.style.display = state.is_running ? 'inline-block' : 'none';

                        // ë°œê²¬ëœ ì¢…ëª© ì‹¤ì‹œê°„ ë Œë”ë§
                        let items = state.found_items || [];
                        let kospiItems = items.filter(i => i.market === 'KOSPI').map((i, idx) => ({ 'ìˆœìœ„': idx + 1, ...i.item }));
                        let kosdaqItems = items.filter(i => i.market === 'KOSDAQ').map((i, idx) => ({ 'ìˆœìœ„': idx + 1, ...i.item }));

                        // ë°ì´í„° ë³€ê²½ ì‹œì—ë§Œ ë Œë”ë§ (ê¹œë¹¡ì„ ë°©ì§€)
                        const currentJson = JSON.stringify(items);
                        if (lastItemsJson[target] !== currentJson) {
                            lastItemsJson[target] = currentJson;

                            if (target === 'price_gc') {
                                renderTable('tbody-gc-kospi', kospiItems, ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'MA20', 'MA200', 'MA20_MA200ê°­(%)', 'ê³¨ë“ í¬ë¡œìŠ¤ì¼']);
                                renderTable('tbody-gc-kosdaq', kosdaqItems, ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'MA20', 'MA200', 'MA20_MA200ê°­(%)', 'ê³¨ë“ í¬ë¡œìŠ¤ì¼']);
                            } else if (target === 'vol_gc') {
                                renderTable('tbody-vol-kospi', kospiItems, ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'V_MA5', 'V_MA20', 'Volume_Ratio(ë°°)']);
                                renderTable('tbody-vol-kosdaq', kosdaqItems, ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'V_MA5', 'V_MA20', 'Volume_Ratio(ë°°)']);
                            } else if (target === 'pullback') {
                                renderTable('tbody-pb-kospi', kospiItems, ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'GCë°œìƒì¼', 'ëˆŒë¦¼ì¼', 'ì‹ í˜¸ìœ í˜•']);
                                renderTable('tbody-pb-kosdaq', kosdaqItems, ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µì›)', 'ì¢…ê°€', 'GCë°œìƒì¼', 'ëˆŒë¦¼ì¼', 'ì‹ í˜¸ìœ í˜•']);
                            }
                        }

                        // ìŠ¤ìº” ì¢…ë£Œ ê°ì§€
                        if (!state.is_running) {
                            clearInterval(intervals[target]);
                            btnEl.style.display = 'inline-block';
                            if (stopBtnEl) stopBtnEl.style.display = 'none';

                            if (state.progress >= 100) {
                                if (msgEl) msgEl.innerHTML = "âœ… ìŠ¤ìº” ì™„ë£Œ!";
                                fetchSignals();
                                setTimeout(() => { progEl.style.display = 'none'; }, 3000);
                            } else {
                                // ì‚¬ìš©ìê°€ ì¤‘ì§€í–ˆê±°ë‚˜ ì˜¤ë¥˜ë¡œ ë©ˆì¶˜ ê²½ìš° ì¦‰ì‹œ ìˆ¨ê¹€
                                progEl.style.display = 'none';
                            }
                        }
                    } else {
                        // ì„œë²„ ì‘ë‹µì´ ì—ëŸ¬(json.ok: false)ì¸ ê²½ìš° ì•ˆì „í•˜ê²Œ ë¦¬ì…‹
                        throw new Error(json.message || "Unknown error");
                    }
                } catch (e) {
                    console.error("Status check error:", e);
                    clearInterval(intervals[target]);
                    if (msgEl) msgEl.innerHTML = "âŒ í†µì‹  ì¤‘ë‹¨ë¨";
                    btnEl.style.display = 'inline-block';
                    if (stopBtnEl) stopBtnEl.style.display = 'none';
                    setTimeout(() => { progEl.style.display = 'none'; }, 2000);
                }
            }, 800); // 0.8ì´ˆë§ˆë‹¤ í™•ì¸
        }

        // ì¼ë°˜ í…Œì´ë¸” ë Œë”ë§
        function renderTable(tbodyId, dataArray, columns) {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;
            tbody.innerHTML = '';

            if (!dataArray || dataArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${columns.length}" class="empty-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }

            dataArray.forEach(row => {
                const tr = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    let val = row[col] !== undefined ? row[col] : '-';

                    // ì¢…ëª©ëª… ì˜†ì— ì¢…ëª©ì½”ë“œ í‘œì‹œ ë° ë„¤ì´ë²„ ë§í¬ ì¶”ê°€
                    if (col === 'ì¢…ëª©ëª…' && row['ì¢…ëª©ì½”ë“œ']) {
                        // ì¢…ëª©ì½”ë“œ í¬ë§·íŒ…: ìˆ«ìë¡œ ë“¤ì–´ì˜¬ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë¬¸ìì—´ ë³€í™˜ ë° 6ìë¦¬ íŒ¨ë”© (ì˜ˆ: 26150 -> 026150)
                        let rawCode = String(row['ì¢…ëª©ì½”ë“œ']).replace(/,/g, '');
                        const paddedCode = rawCode.padStart(6, '0');
                        const naverLink = `https://finance.naver.com/item/main.naver?code=${paddedCode}`;

                        val = `<a href="${naverLink}" target="_blank" style="color: inherit; text-decoration: none; font-weight: 600; border-bottom: 1px dashed #666;">${val}</a> 
                               <span style="color: #aaa; font-size: 0.85em; margin-left: 4px;">(${paddedCode})</span>`;
                    }

                    // ì‹ í˜¸ ìœ í˜• ê°•ì¡°
                    if (col === 'ì‹ í˜¸ìœ í˜•' && typeof val === 'string' && val.includes('ì˜¤ëŠ˜ ì‹ í˜¸')) {
                        val = `<span class="signal-badge">${val}</span>`;
                    }

                    td.innerHTML = val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // íˆ¬ìì í…Œì´ë¸” ë Œë”ë§
        function renderInvestorTable(tbodyId, dataArray) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';

            if (!dataArray || dataArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="empty-msg">KRX ì„œë²„ ì‘ë‹µ ì—†ìŒ (ë´‡ ì°¨ë‹¨ ë˜ëŠ” ë°ì´í„° ë¯¸ì œê³µ).<br>HTS/MTSì—ì„œ ì§ì ‘ í™•ì¸í•´ ì£¼ì„¸ìš”.</td></tr>`;
                return;
            }

            dataArray.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${idx + 1}</td>
            <td class="font-bold">${row['ì¢…ëª©ëª…']}</td>
            <td class="text-right text-highlight">${row['ìˆœë§¤ìˆ˜ê±°ë˜ëŸ‰']}</td>
        `;
                tbody.appendChild(tr);
            });
        }

        function highlightTodaySignals() {
            document.querySelectorAll('.highlight-table tr').forEach(tr => {
                if (tr.innerHTML.includes('ì˜¤ëŠ˜ ì‹ í˜¸')) {
                    tr.classList.add('row-highlight');
                }
            });
        }

        function initEmptyTables() {
            renderTable('tbody-gc-kospi', [], ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µ)', 'ì¢…ê°€', 'MA20', 'MA200', 'ê°­(%)', 'í¬ë¡œìŠ¤ì¼']);
            renderTable('tbody-gc-kosdaq', [], ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µ)', 'ì¢…ê°€', 'MA20', 'MA200', 'ê°­(%)', 'í¬ë¡œìŠ¤ì¼']);
            renderTable('tbody-vol-kospi', [], ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µ)', 'ì¢…ê°€', 'V_MA5', 'V_MA20', 'ë¹„ìœ¨(ë°°)']);
            renderTable('tbody-vol-kosdaq', [], ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡(ì–µ)', 'ì¢…ê°€', 'V_MA5', 'V_MA20', 'ë¹„ìœ¨(ë°°)']);
            renderTable('tbody-pb-kospi', [], ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡', 'ì¢…ê°€', 'GCë°œìƒ', 'ëˆŒë¦¼ì¼', 'ì‹ í˜¸ìœ í˜•']);
            renderTable('tbody-pb-kosdaq', [], ['ìˆœìœ„', 'ì¢…ëª©ëª…', 'ì‹œê°€ì´ì•¡', 'ì¢…ê°€', 'GCë°œìƒ', 'ëˆŒë¦¼ì¼', 'ì‹ í˜¸ìœ í˜•']);
        }

        // ì´ˆê¸° ë¡œë”©: ìŠ¤ìº” ê²°ê³¼ ë¬´ì¡°ê±´ ìˆ¨ê¸°ê³  í…… ë¹ˆ ìƒíƒœë¡œ ì‹œì‘ (ìŠ¤ìº” ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ë§Œ í‘œì‹œ)
        initEmptyTables();

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§„í–‰ ì¤‘ì¸ ìŠ¤ìº”ì´ ìˆëŠ”ì§€ ì²´í¬í•˜ì—¬ ëª¨ë‹ˆí„°ë§ ì¬ê°œ
        async function checkOngoingScans() {
            const targets = [
                { id: 'price_gc', btn: 'btn-scan-price', prog: 'prog-price' },
                { id: 'vol_gc', btn: 'btn-scan-vol', prog: 'prog-vol' },
                { id: 'pullback', btn: 'btn-scan-pb', prog: 'prog-pb' }
            ];

            for (const t of targets) {
                try {
                    const res = await fetch(`/api/scan/status?target=${t.id}`);
                    const json = await res.json();
                    if (json.ok && json.data.is_running) {
                        monitorScan(t.id, t.btn, t.prog);
                    }
                } catch (e) {
                    console.error(`Status check failed for ${t.id}:`, e);
                }
            }
        }

        checkOngoingScans();
        // fetchSignals(); // ê¸°ì¡´ ê²°ê³¼ë¥¼ ë¡œë“œí•˜ì§€ ì•Šê³  ê¹¨ë—í•œ ìƒíƒœë¡œ ì‹œì‘

    </script>
</body>

</html>